-- PART 1 OF 2 (FIXED CORE + SAFE ANIMATIONS + PLAYERLOCK LOGIC)

local vu1 = game:GetService("Players").LocalPlayer
local vu2 = game:GetService("UserInputService")
local vu3 = game:GetService("TweenService")
local vu4 = game:GetService("RunService")
local v5  = game:GetService("Workspace")
game:GetService("ReplicatedStorage")

local vu6
pcall(function() vu6 = game:GetService("VirtualInputManager") end)
if not vu6 then
    local v7 = rawget(getgenv(), "VirtualInputManager")
    if v7 then
        vu6 = v7
    else
        local v8 = rawget(getgenv(), "syn") and rawget(getgenv(), "syn").virtualinput
        if v8 then
            vu6 = v8
        else
            vu6 = rawget(getgenv(), "virtualinputmanager")
        end
    end
end

local vu9 = {M1RESET = Enum.KeyCode.R, EMOTEDASH = Enum.KeyCode.T}
getgenv().connections = getgenv().connections or {}
if type(getgenv().connections) == "table" then
    for _, c in ipairs(getgenv().connections) do
        pcall(function()
            if c and c.Disconnect then c:Disconnect() end
        end)
    end
end
getgenv().connections = {}

local function vu21(timeout)
    local t = timeout or 2
    if type(gethui) == "function" then
        local ok, gui = pcall(gethui)
        if ok and gui then return gui end
    end
    if vu1 then
        local start = tick()
        while tick() - start < t do
            if vu1:FindFirstChild("PlayerGui") then
                return vu1.PlayerGui
            end
            task.wait(0.05)
        end
        if vu1:FindFirstChild("PlayerGui") then
            return vu1.PlayerGui
        end
    end
    local ok, core = pcall(function() return game:GetService("CoreGui") end)
    return ok and core or game:GetService("StarterGui")
end

local vu22 = vu21()
pcall(function()
    for _, name in ipairs({"M1RESETUI","TSBUI","M1ResetUI"}) do
        local g = vu22:FindFirstChild(name)
        if g then g:Destroy() end
    end
end)

local function protectGui(g)
    local synObj = rawget(getgenv(), "syn")
    if synObj and type(synObj.protect_gui or synObj.protectgui) == "function" then
        pcall(function()
            (synObj.protect_gui or synObj.protectgui)(g)
        end)
    end
end

local themes = {
    {name="Dark",  Panel=Color3.fromRGB(30,30,30),  Button=Color3.fromRGB(50,50,50),  Accent=Color3.fromRGB(200,200,200), Text=Color3.fromRGB(255,255,255)},
    {name="Gray",  Panel=Color3.fromRGB(60,60,60),  Button=Color3.fromRGB(80,80,80),  Accent=Color3.fromRGB(150,150,150), Text=Color3.fromRGB(255,255,255)},
    {name="Black", Panel=Color3.fromRGB(20,20,20),  Button=Color3.fromRGB(40,40,40),  Accent=Color3.fromRGB(100,100,100), Text=Color3.fromRGB(255,255,255)},
    {name="Neon",  Panel=Color3.fromRGB(10,10,10),  Button=Color3.fromRGB(0,200,255), Accent=Color3.fromRGB(255,0,255),   Text=Color3.fromRGB(255,255,255)},
    {name="Cyber", Panel=Color3.fromRGB(15,15,20),  Button=Color3.fromRGB(35,35,45), Accent=Color3.fromRGB(0,255,150),   Text=Color3.fromRGB(255,255,255)}
}
local themeIndex = 1
local currentTheme = themes[1]

local function addCorner(obj, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 12)
    c.Parent = obj
end

local function addStroke(obj, color, thickness, transparency)
    local s = Instance.new("UIStroke")
    s.Color = color or currentTheme.Accent
    s.Thickness = thickness or 1
    s.Transparency = transparency or 0.5
    s.Parent = obj
end

local uiButtons = {}
local using = false
local animCache = {}
local cam = v5.CurrentCamera

-- aimlock / player lock state
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local aimlockEnabled = false
local currentTarget = nil

local function getCharAndHum()
    local char = vu1 and vu1.Character or nil
    local hum = char and char:FindFirstChildOfClass("Humanoid") or nil
    return char, hum
end

local function stopAllAnims()
    local _, hum = getCharAndHum()
    local animator = hum and hum:FindFirstChildOfClass("Animator")
    if animator then
        local ok, tracks = pcall(function() return animator:GetPlayingAnimationTracks() end)
        if ok and tracks then
            for _, tr in ipairs(tracks) do
                pcall(function() tr:Stop() end)
            end
        end
    end
end

-- SAFE ANIMATION LOADER (prevents nil value crash)
local function playAnim(id)
    local _, hum = getCharAndHum()
    if not hum then return nil end
    local animator = hum:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator")
        animator.Parent = hum
    end

    local anim = animCache[id]
    if not anim then
        anim = Instance.new("Animation")
        anim.AnimationId = "rbxassetid://" .. tostring(id)
        animCache[id] = anim
    end

    local ok, track = pcall(function()
        return animator:LoadAnimation(anim)
    end)
    if not ok or not track then
        return nil
    end

    track.Priority = Enum.AnimationPriority.Action
    track:Play()
    pcall(function() track:AdjustSpeed(1.2) end)
    return track
end

-- basic root helper
local function getRoot()
    local char, _ = getCharAndHum()
    return char and char:FindFirstChild("HumanoidRootPart") or nil
end

-- PLAYERLOCK helpers
local function getTargetInViewCone()
    local root = getRoot()
    if not root or not cam then return nil end
    local live = workspace:FindFirstChild("Live")
    if not live then return nil end

    local look = cam.CFrame.LookVector
    local bestAngle = 30
    local best = nil

    for _, m in ipairs(live:GetChildren()) do
        if m:IsA("Model") and m ~= LocalPlayer.Character then
            local head = m:FindFirstChild("Head")
            local hum = m:FindFirstChild("Humanoid")
            if head and hum and hum.Health > 0 then
                local dir = (head.Position - cam.CFrame.Position).Unit
                local angle = math.deg(math.acos(math.clamp(look:Dot(dir), -1, 1)))
                if angle < bestAngle then
                    bestAngle = angle
                    best = m
                end
            end
        end
    end
    return best
end

local function getNearestTargetByDistance(maxDist)
    maxDist = maxDist or 20
    local root = getRoot()
    if not root then return nil end
    local live = workspace:FindFirstChild("Live")
    if not live then return nil end

    local best, bestDist = nil, maxDist
    for _, m in ipairs(live:GetChildren()) do
        if m:IsA("Model") and m ~= LocalPlayer.Character then
            local head = m:FindFirstChild("Head")
            local hum = m:FindFirstChild("Humanoid")
            if head and hum and hum.Health > 0 then
                local d = (head.Position - root.Position).Magnitude
                if d < bestDist then
                    bestDist = d
                    best = m
                end
            end
        end
    end
    return best
end

-- rotate / tween / dash funcs stay same logic
local function spinRoot(deg)
    if using then return end
    using = true
    local root = getRoot()
    if root then
        pcall(function()
            root.CFrame = root.CFrame * CFrame.Angles(0, math.rad(deg), 0)
        end)
        if cam and cam:IsA("Camera") then
            local pos = (cam.CFrame.Position + Vector3.new(0,5,0))
            local offset = (pos - root.Position)
            local flat = Vector3.new(offset.X, 0, offset.Z)
            local rot = CFrame.fromAxisAngle(Vector3.yAxis, math.rad(deg)) * flat
            local lookAt = root.Position + rot
            cam.CFrame = CFrame.lookAt(Vector3.new(lookAt.X,pos.Y,lookAt.Z), root.Position)
        end
    end
    using = false
end

local function tweenRoot(dx, dz, t)
    if using then return end
    using = true
    local root = getRoot()
    if root then
        local tw = vu3:Create(root, TweenInfo.new(t, Enum.EasingStyle.Sine, Enum.EasingDirection.Out),
            {CFrame = root.CFrame * CFrame.new(dx, 0, dz)})
        pcall(function() tw:Play() end)
        pcall(function() tw.Completed:Wait() end)
        pcall(function() tw:Destroy() end)
    end
    using = false
end

local function dashRight(multX, multY, up, speed, dur)
    if using then return end
    using = true
    local root = getRoot()
    if root then
        local bv = Instance.new("BodyVelocity")
        local vel = root.CFrame.RightVector * multX + Vector3.new(0, up, 0) * multY
        if vel.Magnitude == 0 then vel = Vector3.new(0,1,0) end
        bv.Velocity = vel.Unit * speed
        bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bv.Parent = root
        task.delay(dur, function()
            pcall(function() bv:Destroy() end)
        end)
    end
    using = false
end

local function doM1Reset()
    stopAllAnims()
    playAnim(10480793962) -- safe now, silently fails if private
    tweenRoot(1, 26, 0.22)
    spinRoot(70)
    task.wait(0.003)
    if vu6 and type(vu6.SendKeyEvent) == "function" then
        vu6:SendKeyEvent(true, Enum.KeyCode.Q, false, game)
        vu6:SendKeyEvent(false, Enum.KeyCode.Q, false, game)
    end
end

local function doEmoteDash()
    stopAllAnims()
    playAnim(10480793962)
    spinRoot(90)
    dashRight(1, 38, 8, 95, 0.27)
end

-- playerlock update loop
vu4.Stepped:Connect(function()
    if not aimlockEnabled then return end
    if not currentTarget then
        currentTarget = getTargetInViewCone()
    end
    if currentTarget then
        local hum = currentTarget:FindFirstChild("Humanoid")
        if not currentTarget.Parent or not hum or hum.Health <= 0 then
            currentTarget = getNearestTargetByDistance(20)
        end
    end
    if currentTarget then
        local head = currentTarget:FindFirstChild("Head")
        local root = getRoot()
        if head and root then
            local rp = root.Position
            local hp = head.Position
            local dir = Vector3.new(hp.X - rp.X, 0, hp.Z - rp.Z)
            if dir.Magnitude > 0.01 then
                root.CFrame = CFrame.new(rp, rp + dir)
            end
        end
    end
end)

-- GUI creation (same as original, plus playerlock text)
local mainGui = Instance.new("ScreenGui")
mainGui.Name = "M1RESETUI"
mainGui.ResetOnSpawn = false
mainGui.IgnoreGuiInset = true
mainGui.DisplayOrder = 9999
mainGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
protectGui(mainGui)
local function attachGui()
    local parent = vu1 and vu1:FindFirstChild("PlayerGui") or vu21()
    pcall(function() mainGui.Parent = parent end)
end
attachGui()

local headerFrame = Instance.new("Frame", mainGui)
headerFrame.Size = UDim2.fromOffset(300,160)
headerFrame.Position = UDim2.new(0.5,-150,0.1,-200)
headerFrame.BackgroundColor3 = currentTheme.Panel
headerFrame.BackgroundTransparency = 0.15
addCorner(headerFrame,14)
addStroke(headerFrame,currentTheme.Accent,1,0.5)

local headerText = Instance.new("TextLabel", headerFrame)
headerText.Size = UDim2.fromScale(1,1)
headerText.BackgroundTransparency = 1
headerText.TextColor3 = currentTheme.Text
headerText.Font = Enum.Font.GothamBold
headerText.TextSize = 20
headerText.TextWrapped = true
headerText.Text = "M1 Reset by dovi!\nR = M1 Reset & Player Lock Toggle\nT = Emote Dash"

pcall(function()
    vu3:Create(headerFrame,TweenInfo.new(0.5,Enum.EasingStyle.Bounce,Enum.EasingDirection.Out),
        {Position = UDim2.new(0.5,-150,0.1,0)}):Play()
end)
task.delay(4,function()
    pcall(function()
        vu3:Create(headerFrame,TweenInfo.new(0.3,Enum.EasingStyle.Quad,Enum.EasingDirection.In),
            {Position = UDim2.new(0.5,-150,0.1,-200)}):Play()
    end)
    task.wait(0.4)
    pcall(function() if headerFrame.Parent then headerFrame:Destroy() end end)
end)

-- END PART 1 (rest UI + binds below)
[file:1] -- comment end of snippet 1
-- PART 2 OF 2 (UI BUTTONS + MOBILE UI + INPUT BINDS, FIXED)

local panel = Instance.new("Frame", mainGui)
panel.Size = UDim2.new(0,190,0,200)
panel.Position = UDim2.new(0,20,0.5,0)
panel.BackgroundColor3 = currentTheme.Panel
panel.BackgroundTransparency = 1
addCorner(panel,16)
addStroke(panel,currentTheme.Accent,1,0.5)

pcall(function()
    vu3:Create(panel,TweenInfo.new(0.4),{BackgroundTransparency = 0.2}):Play()
end)

local dragging = false
local dragInput, dragStartPos, dragStartPanelPos

panel.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragInput = input
        dragStartPos = input.Position
        dragStartPanelPos = panel.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

panel.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

vu4.RenderStepped:Connect(function()
    if dragging and dragInput and dragStartPos and dragStartPanelPos then
        local delta = dragInput.Position - dragStartPos
        panel.Position = UDim2.new(
            dragStartPanelPos.X.Scale, dragStartPanelPos.X.Offset + delta.X,
            dragStartPanelPos.Y.Scale, dragStartPanelPos.Y.Offset + delta.Y
        )
    end
end)

local topBar = Instance.new("Frame", panel)
topBar.Size = UDim2.new(1,0,0,34)
topBar.BackgroundTransparency = 1

local title = Instance.new("TextLabel", topBar)
title.Size = UDim2.new(1,-130,1,0)
title.Position = UDim2.new(0,12,0,0)
title.BackgroundTransparency = 1
title.Text = "M1 reset by dovi!"
title.Font = Enum.Font.GothamBlack
title.TextSize = 16
title.TextColor3 = currentTheme.Text
title.TextXAlignment = Enum.TextXAlignment.Left

local themeBtn = Instance.new("TextButton", topBar)
themeBtn.Size = UDim2.new(0,100,0,30)
themeBtn.Position = UDim2.new(1,-110,0.5,-15)
themeBtn.BackgroundColor3 = currentTheme.Button
themeBtn.TextColor3 = currentTheme.Text
themeBtn.Font = Enum.Font.GothamBold
themeBtn.TextSize = 14
themeBtn.Text = "Theme: "..currentTheme.name
addCorner(themeBtn,10)
addStroke(themeBtn,currentTheme.Accent,1,0.5)

local function refreshTheme()
    for _, d in ipairs(mainGui:GetDescendants()) do
        if d:IsA("TextLabel") or d:IsA("TextButton") then
            d.TextColor3 = currentTheme.Text
        end
        if d:IsA("Frame") then
            d.BackgroundColor3 = currentTheme.Panel
        end
        if d:IsA("TextButton") and d.Name == "MobileBtn" then
            d.BackgroundColor3 = currentTheme.Button
        end
        local s = d:FindFirstChildOfClass("UIStroke")
        if s then
            pcall(function() s.Color = currentTheme.Accent end)
        end
    end
    for _, b in ipairs(uiButtons) do
        b.BackgroundColor3 = currentTheme.Button
        b.TextColor3 = currentTheme.Text
        local s = b:FindFirstChildOfClass("UIStroke")
        if s then pcall(function() s.Color = currentTheme.Accent end) end
    end
end

themeBtn.MouseButton1Click:Connect(function()
    themeIndex = themeIndex + 1
    if themeIndex > #themes then themeIndex = 1 end
    currentTheme = themes[themeIndex]
    themeBtn.Text = "Theme: "..currentTheme.name
    refreshTheme()
end)

local function makeActionButton(text, y, callback)
    local btn = Instance.new("TextButton", panel)
    btn.Size = UDim2.new(1,-24,0,44)
    btn.Position = UDim2.new(0,12,0,y)
    btn.BackgroundColor3 = currentTheme.Button
    btn.TextColor3 = currentTheme.Text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 16
    btn.Text = text
    btn.AutoButtonColor = false
    addCorner(btn,12)
    addStroke(btn,currentTheme.Accent,1,0.5)

    btn.MouseEnter:Connect(function()
        pcall(function()
            vu3:Create(btn,TweenInfo.new(0.15),
                {BackgroundColor3 = currentTheme.Accent, Size = UDim2.new(1,-22,0,46)}):Play()
        end)
    end)
    btn.MouseLeave:Connect(function()
        pcall(function()
            vu3:Create(btn,TweenInfo.new(0.15),
                {BackgroundColor3 = currentTheme.Button, Size = UDim2.new(1,-24,0,44)}):Play()
        end)
    end)
    btn.MouseButton1Down:Connect(function()
        pcall(function()
            vu3:Create(btn,TweenInfo.new(0.1),
                {Size = UDim2.new(1,-26,0,42)}):Play()
        end)
    end)
    btn.MouseButton1Up:Connect(function()
        pcall(function()
            vu3:Create(btn,TweenInfo.new(0.1),
                {Size = UDim2.new(1,-22,0,46)}):Play()
        end)
    end)
    btn.MouseButton1Click:Connect(function()
        task.spawn(function()
            pcall(callback)
        end)
    end)

    table.insert(uiButtons, btn)
    return btn
end

local m1Btn      = makeActionButton("M1 Reset",   54,  doM1Reset)
local playerBtn  = makeActionButton("Player Lock",104, function()
    aimlockEnabled = not aimlockEnabled
end)
local unloadBtn  = makeActionButton("Unload",    154, function()
    for _, c in ipairs(getgenv().connections) do
        pcall(function()
            if c and c.Disconnect then c:Disconnect() end
        end)
    end
    getgenv().connections = {}
    pcall(function() mainGui:Destroy() end)
end)

local mobileOn = false
local mobileButtons = {}

local function makeMobileButton(templateBtn, index)
    task.wait(0.1)
    local vp = cam and cam.ViewportSize or Vector2.new(1920,1080)
    local x = 20 + (index-1)*150
    local y = vp.Y - 100
    local b = Instance.new("TextButton", mainGui)
    b.Size = UDim2.new(0,140,0,45)
    b.Position = UDim2.new(0, math.clamp(x,12,vp.X-150), 0, math.clamp(y,12,vp.Y-60))
    b.BackgroundColor3 = currentTheme.Button
    b.TextColor3 = currentTheme.Text
    b.Font = templateBtn.Font
    b.TextSize = templateBtn.TextSize
    b.Text = templateBtn.Text
    addCorner(b,12)
    addStroke(b,currentTheme.Accent,1,0.5)
    b.ZIndex = 100
    b.BackgroundTransparency = 1
    b.TextTransparency = 1
    pcall(function()
        vu3:Create(b,TweenInfo.new(0.3),
            {BackgroundTransparency = 0,TextTransparency = 0}):Play()
    end)

    b.MouseButton1Click:Connect(function()
        if b.Text:find("M1") then
            doM1Reset()
        elseif b.Text:find("Player") then
            aimlockEnabled = not aimlockEnabled
        elseif b.Text:find("Emote") then
            doEmoteDash()
        end
    end)

    local drag = false
    local dragInp, dragStart, dragStartOffset
    b.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1
            or i.UserInputType == Enum.UserInputType.Touch then
            drag = true
            dragInp = i
            dragStart = i.Position
            dragStartOffset = Vector2.new(b.Position.X.Offset,b.Position.Y.Offset)
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then
                    drag = false
                end
            end)
        end
    end)
    b.InputChanged:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseMovement
            or i.UserInputType == Enum.UserInputType.Touch then
            dragInp = i
        end
    end)

    local conn
    conn = vu4.RenderStepped:Connect(function()
        if drag and dragInp and dragStart and dragStartOffset then
            local delta = dragInp.Position - dragStart
            local pos = dragStartOffset + Vector2.new(delta.X,delta.Y)
            b.Position = UDim2.new(0,pos.X,0,pos.Y)
        end
    end)
    b.AncestryChanged:Connect(function()
        if not b.Parent and conn then conn:Disconnect() end
    end)

    table.insert(mobileButtons, b)
    return b
end

local mobileBtn = Instance.new("TextButton", panel)
mobileBtn.Size = UDim2.new(0,100,0,30)
mobileBtn.Position = UDim2.new(1,-110,1,5)
mobileBtn.BackgroundColor3 = currentTheme.Button
mobileBtn.TextColor3 = currentTheme.Text
mobileBtn.Font = Enum.Font.GothamBold
mobileBtn.TextSize = 14
mobileBtn.Text = "Mobile OFF"
mobileBtn.Name = "MobileBtn"
addCorner(mobileBtn,10)
addStroke(mobileBtn,currentTheme.Accent,1,0.5)

mobileBtn.MouseButton1Click:Connect(function()
    mobileOn = not mobileOn
    mobileBtn.Text = mobileOn and "Mobile ON" or "Mobile OFF"
    if mobileOn then
        pcall(function()
            vu3:Create(panel,TweenInfo.new(0.3),
                {Size = UDim2.new(0,160,0,100)}):Play()
        end)
        panel.Position = UDim2.new(0,20,0.6,0)
        m1Btn.Visible = false
        playerBtn.Visible = false
        pcall(function()
            vu3:Create(unloadBtn,TweenInfo.new(0.3),
                {Position = UDim2.new(0,12,0,54)}):Play()
        end)
        table.insert(mobileButtons, makeMobileButton(m1Btn,1))
        table.insert(mobileButtons, makeMobileButton(playerBtn,2))
    else
        for _, b in ipairs(mobileButtons) do
            pcall(function()
                vu3:Create(b,TweenInfo.new(0.2),
                    {BackgroundTransparency = 1,TextTransparency = 1}):Play()
            end)
            task.wait(0.3)
            pcall(function() b:Destroy() end)
        end
        mobileButtons = {}
        pcall(function()
            vu3:Create(panel,TweenInfo.new(0.3),
                {Size = UDim2.new(0,190,0,200)}):Play()
        end)
        panel.Position = UDim2.new(0,20,0.5,0)
        m1Btn.Visible = true
        playerBtn.Visible = true
        pcall(function()
            vu3:Create(unloadBtn,TweenInfo.new(0.3),
                {Position = UDim2.new(0,12,0,154)}):Play()
        end)
    end
end)

refreshTheme()

local inputConn = vu2.InputBegan:Connect(function(input, gp)
    if gp then return end
    if vu2:GetFocusedTextBox() then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == vu9.M1RESET then
            -- R = do M1 reset and toggle player lock as requested
            doM1Reset()
            aimlockEnabled = not aimlockEnabled
        elseif input.KeyCode == vu9.EMOTEDASH then
            doEmoteDash()
        end
    end
end)
table.insert(getgenv().connections, inputConn)

-- END PART 2 (all important features kept, animation crash fixed, playerlock integrated)
[file:1][image:1]
